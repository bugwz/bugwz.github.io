<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>ceph-ansible 集群部署运维指南 | 咕咕</title><meta name="author" content="bugwz"><meta name="copyright" content="bugwz"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="本文详细介绍了使用 ceph-ansible 部署和运维 Ceph 集群的过程，包括各版本及其依赖的 Ansible 版本的对应关系、自定义模块与任务的结构、集群部署、运维操作及相关示例。特别强调了环境配置、节点连通性验证、MDS 和 OSD 组件的管理，以及安全和性能优化注意事项。"><meta property="og:type" content="article"><meta property="og:title" content="ceph-ansible 集群部署运维指南"><meta property="og:url" content="https://bugwz.com/2023/04/12/ceph-ansible/index.html"><meta property="og:site_name" content="咕咕"><meta property="og:description" content="本文详细介绍了使用 ceph-ansible 部署和运维 Ceph 集群的过程，包括各版本及其依赖的 Ansible 版本的对应关系、自定义模块与任务的结构、集群部署、运维操作及相关示例。特别强调了环境配置、节点连通性验证、MDS 和 OSD 组件的管理，以及安全和性能优化注意事项。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://bugwz.com/assets/images/bg/ceph.webp"><meta property="article:published_time" content="2023-04-11T16:00:00.000Z"><meta property="article:modified_time" content="2025-12-16T13:38:47.370Z"><meta property="article:author" content="bugwz"><meta property="article:tag" content="Ceph"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bugwz.com/assets/images/bg/ceph.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ceph-ansible 集群部署运维指南",
  "url": "https://bugwz.com/2023/04/12/ceph-ansible/",
  "image": "https://bugwz.com/assets/images/bg/ceph.webp",
  "datePublished": "2023-04-11T16:00:00.000Z",
  "dateModified": "2025-12-16T13:38:47.370Z",
  "author": [
    {
      "@type": "Person",
      "name": "bugwz",
      "url": "https://bugwz.com"
    }
  ]
}</script><link rel="shortcut icon" href="/assets/images/bg/favicon.png"><link rel="canonical" href="https://bugwz.com/2023/04/12/ceph-ansible/index.html"><link rel="preconnect"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><noscript><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"></noscript><script>(()=>{const e={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:e,getScript:(e,t={})=>new Promise((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach(([e,t])=>n.setAttribute(e,t)),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),getCSS:(e,t)=>new Promise((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),addGlobalFn:(e,t,o=!1,a=window)=>{if(e.startsWith("pjax"))return;const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const t=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},o=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};btf.activateDarkMode=t,btf.activateLightMode=o;const a=e.get("theme");"dark"===a?t():"light"===a&&o();const n=e.get("aside-status");void 0!==n&&document.documentElement.classList.toggle("hide-aside","hide"===n);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:void 0,translate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:500,highlightFullpage:!1,highlightMacStyle:!0},copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"null",Snackbar:void 0,infinitegrid:{js:"/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyloadPlugin:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"ceph-ansible 集群部署运维指南",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel="stylesheet" href="/self/github-dark.css" media="print" onload='this.media="all"'><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><meta name="generator" content="Hexo 8.1.1"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/assets/images/bg/avatar.webp" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"/ loading='lazy'></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">137</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">139</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives"><span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags"><span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories"><span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link"><span>友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/assets/images/bg/ceph.webp)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">咕咕</span></a><a class="nav-page-title" href="/"><span class="site-name">ceph-ansible 集群部署运维指南</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span> 返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives"><span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags"><span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories"><span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link"><span>友链</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ceph-ansible 集群部署运维指南</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-04-11T16:00:00.000Z" title="发表于 2023-04-12 00:00:00">2023-04-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-16T13:38:47.370Z" title="更新于 2025-12-16 21:38:47">2025-12-16</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">3.2k</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>本文详细介绍了使用 ceph-ansible 部署和运维 Ceph 集群的过程，包括各版本及其依赖的 Ansible 版本的对应关系、自定义模块与任务的结构、集群部署、运维操作及相关示例。特别强调了环境配置、节点连通性验证、MDS 和 OSD 组件的管理，以及安全和性能优化注意事项。</p><h1 id="一、项目介绍"><a href="#一、项目介绍" class="headerlink" title="一、项目介绍"></a>一、项目介绍</h1><p>以下分析基于 ceph-ansible stable-6.0 分支代码。</p><h2 id="1-1、版本与对应关系"><a href="#1-1、版本与对应关系" class="headerlink" title="1.1、版本与对应关系"></a>1.1、版本与对应关系</h2><p>目前 ceph-ansible 采用不同的代码分支来支持部署不同版本的 ceph 集群，且每个代码分支需要特定的 ansible 版本支持，具体的对应关系如下（以下对应关系更新于 2025&#x2F;05&#x2F;23 ）：</p><table><thead><tr><th align="center">ceph-ansible 分支</th><th align="center">支持的 ceph 版本</th><th align="center">依赖的 ansible 核心版本</th><th align="center">依赖的 ansible 发布版本包</th></tr></thead><tbody><tr><td align="center">stable-3.0</td><td align="center">Jewel(V10), Luminous(V12)</td><td align="center">2.4</td><td align="center">-</td></tr><tr><td align="center">stable-3.1</td><td align="center">Luminous(V12), Mimic(V13)</td><td align="center">2.4</td><td align="center">-</td></tr><tr><td align="center">stable-3.2</td><td align="center">Luminous(V12), Mimic(V13)</td><td align="center">2.6</td><td align="center">-</td></tr><tr><td align="center">stable-4.0</td><td align="center">Nautilus(V14)</td><td align="center">2.9</td><td align="center">-</td></tr><tr><td align="center">stable-5.0</td><td align="center">Octopus(V15)</td><td align="center">2.9</td><td align="center">-</td></tr><tr><td align="center">stable-6.0</td><td align="center">Pacific(V16)</td><td align="center">2.10</td><td align="center">2.10&#x2F;3.x</td></tr><tr><td align="center">stable-7.0</td><td align="center">Quincy(V17)</td><td align="center">2.15</td><td align="center">8.x</td></tr><tr><td align="center">stable-8.0</td><td align="center">Reef(V18)</td><td align="center">2.15&#x2F;2.16</td><td align="center">8.x&#x2F;9.x</td></tr><tr><td align="center">stable-9.0</td><td align="center">Squid(V19)</td><td align="center">2.15&#x2F;2.16</td><td align="center">8.x&#x2F;9.x</td></tr><tr><td align="center">main</td><td align="center">devel</td><td align="center">2.15&#x2F;2.16</td><td align="center">8.x&#x2F;9.x</td></tr></tbody></table><p>补充 Ansible 的社区更新日志对应信息，<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/devel/reference_appendices/release_and_maintenance.html#ansible-community-changelogs">原始地址</a> ：</p><table><thead><tr><th align="center">Ansible 社区软件包</th><th align="center">状态</th><th align="center">依赖的核心版本</th></tr></thead><tbody><tr><td align="center">12.0.0</td><td align="center">开发中（未发布）</td><td align="center">2.19</td></tr><tr><td align="center"><a target="_blank" rel="noopener" href="https://github.com/ansible-community/ansible-build-data/blob/main/11/CHANGELOG-v11.md">11.x</a></td><td align="center">当前</td><td align="center">2.18</td></tr><tr><td align="center"><a target="_blank" rel="noopener" href="https://github.com/ansible-community/ansible-build-data/blob/main/10/CHANGELOG-v10.md">10.x</a></td><td align="center">10.7 之后 EOL</td><td align="center">2.17</td></tr><tr><td align="center"><a target="_blank" rel="noopener" href="https://github.com/ansible-community/ansible-build-data/blob/main/9/CHANGELOG-v9.rst">9.x</a></td><td align="center">9.13 之后 EOL</td><td align="center">2.16</td></tr><tr><td align="center"><a target="_blank" rel="noopener" href="https://github.com/ansible-community/ansible-build-data/blob/main/8/CHANGELOG-v8.rst">8.x</a></td><td align="center">不再维护（生命周期结束）</td><td align="center">2.15</td></tr><tr><td align="center"><a target="_blank" rel="noopener" href="https://github.com/ansible-community/ansible-build-data/blob/main/7/CHANGELOG-v7.rst">7.x</a></td><td align="center">不再维护（生命周期结束）</td><td align="center">2.14</td></tr><tr><td align="center"><a target="_blank" rel="noopener" href="https://github.com/ansible-community/ansible-build-data/blob/main/6/CHANGELOG-v6.rst">6.x</a></td><td align="center">不再维护（生命周期结束）</td><td align="center">2.13</td></tr><tr><td align="center"><a target="_blank" rel="noopener" href="https://github.com/ansible-community/ansible-build-data/blob/main/5/CHANGELOG-v5.rst">5.x</a></td><td align="center">不再维护（生命周期结束）</td><td align="center">2.12</td></tr><tr><td align="center"><a target="_blank" rel="noopener" href="https://github.com/ansible-community/ansible-build-data/blob/main/4/CHANGELOG-v4.rst">4.x</a></td><td align="center">不再维护（生命周期结束）</td><td align="center">2.11</td></tr><tr><td align="center"><a target="_blank" rel="noopener" href="https://github.com/ansible-community/ansible-build-data/blob/main/3/CHANGELOG-v3.rst">3.x</a></td><td align="center">不再维护（生命周期结束）</td><td align="center">2.10</td></tr><tr><td align="center"><a target="_blank" rel="noopener" href="https://github.com/ansible-community/ansible-build-data/blob/main/2.10/CHANGELOG-v2.10.rst">2.10</a></td><td align="center">不再维护（生命周期结束）</td><td align="center">2.10</td></tr></tbody></table><h2 id="1-2、目录结构"><a href="#1-2、目录结构" class="headerlink" title="1.2、目录结构"></a>1.2、目录结构</h2><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">.<br>├── contrib<br>├── docs<br>├── group_vars<br>├── infrastructure-playbooks<br>├── library<br>├── module_utils<br>├── plugins<br>├── profiles<br>├── roles<br>├── tests<br>├── requirements.txt<br>├── requirements.yml<br>├── site-container.yml.sample<br>├── site.yml.sample<br></code></pre></td></tr></table></figure><ul><li><code>docs</code> : <a target="_blank" rel="noopener" href="https://docs.ceph.com/projects/ceph-ansible/en/stable-6.0/">ceph-ansible doc</a> 的原始文档，用于展示不同分支版本的文档资料；</li><li><code>group_vars</code> : 定义 Ceph 不同组件（mon，osd等）的一些初始配置，在部署集群时会修改其中的配置进行自定义的集群部署；</li><li><code>infrastructure-playbooks</code> : Ceph 相关的 ansible 的 playbooks ，主要用于管控操作 Ceph 集群；</li><li><code>library</code> : Ceph 相关的自定义 ansible 模块，用于完成 Ceph 相关的一些操作；</li><li><code>roles</code> : Ceph 相关的自定义 ansible 任务，后续会通过 include_role 和 import_role 的方式引入并执行这些任务；</li><li><code>tests</code> : 测试代码；</li></ul><h2 id="1-3、自定义模块"><a href="#1-3、自定义模块" class="headerlink" title="1.3、自定义模块"></a>1.3、自定义模块</h2><p>ceph-ansible 为了更好的编写部署、管控的 playbooks ，引入了很多自定义的模块，用于更好的操作 ceph 集群。这些自定义模块均位于 .&#x2F;library 目录。</p><ul><li><code>ceph_add_user_buckets.py</code> : 创建 bucket 和 user 对象，调用 boto 和 radosgw 相关库的实现；</li><li><code>ceph_crush_rule.py</code> : 依据不同的 state 执行不同的操作。present 表示新增 crush rule ， absent 表示移除 crush rule ， info 表示查看 crush rule 信息；</li><li><code>ceph_crush.py</code> : 获取 crush map 并排列 item 节点信息；</li><li><code>ceph_dashboard_user.py</code> : 依据不同的 state 执行不同的操作。present 表示新增加 dashboard 的用户并设置角色&#x2F;密码等 ， absent 表示移除 dashboard 的用户 ， info 表示查看 dashboard 的用户信息；</li><li><code>ceph_ec_profile.py</code> : 依据不同的 state 执行不同的操作。present 表示设置纠删码配置，absent 表示删除纠删码配置；</li><li><code>ceph_fs.py</code> : 依据不同的 state 执行不同的操作。present 表示设置文件系统配置，absent 表示删除文件系统配置，info 表示查看文件系统配置；</li><li><code>ceph_key.py</code> : 依据不同的 state 执行不同的操作。present&#x2F;update 表示设置密钥信息，absent 表示删除密钥信息，info 表示查看密钥信息，list 表示遍历所有密钥信息， fetch_initial_keys 表示获取特定密钥信息，generate_secret 表示生成密钥内容；</li><li><code>ceph_mgr_module.py</code> :</li><li><code>ceph_osd_flag.py</code> : 依据不同的 state 执行不同的操作。present 表示设置 osd flag ， absent 表示重置 osd flag ；</li><li><code>ceph_osd.py</code> : 依据不同的 state 执行不同的操作。destroy 表示销毁 osd 且单次只能操作一个，down 表示下线 osd ，in 表示接入 osd ，out 表示移除 osd ，purge 表示清除 osd 且单次只能操作一个 ，rm 表示删除 osd ；</li><li><code>ceph_pool.py</code> : 操作 pool 相关；</li><li><code>ceph_volumn_simple_activate.py</code> :</li><li><code>ceph_volumn_simple_scan.py</code> :</li><li><code>ceph_volumn.py</code> :</li><li><code>cephadm_adopt.py</code> : 采用具有 cephadm 的 ceph 集群；</li><li><code>cephadm_bootstrap.py</code> : 通过 cephadm 引导 ceph 集群；</li><li><code>igw_client.py</code> : 管理 iscsi 网关客户端定义；</li><li><code>igw_gateway.py</code> : 管理 iscsi 网关定义；</li><li><code>igw_lun.py</code> : 管理 ceph-rbd 映像以作为 iscsi lun 呈现给客户端；</li><li><code>igw_purge.py</code> : 提供清除功能以删除 iscsi 网关；</li><li><code>radosgw_caps.py</code> : 管理 RADOS 网关管理功能；</li><li><code>radosgw_realm.py</code> : 管理 RADOS 网关领域；</li><li><code>radosgw_user.py</code> : 管理 RADOS 网关用户；</li><li><code>radosgw_zone.py</code> : 管理 RADOS 网关区域；</li><li><code>radosgw_zonegroup.py</code> : 管理 RADOS 网关区域组；</li></ul><h2 id="1-4、自定义任务"><a href="#1-4、自定义任务" class="headerlink" title="1.4、自定义任务"></a>1.4、自定义任务</h2><p>ceph-ansible 内部抽象了一些任务列表，目录位于：.&#x2F;roles。</p><ul><li><code>ceph-client</code> : 创建分发用户密钥；</li><li><code>ceph-common</code> : 配置 ceph 的安装仓库，配置内存分配器等；</li><li><code>ceph-config</code> : 创建 ceph 的数据目录，生成集群配置文件等；</li><li><code>ceph-container-common</code> : 拉取 ceph 相关的容器镜像；</li><li><code>ceph-container-engine</code> : 初始化容器引擎的基础信息（仓库地址等）；</li><li><code>ceph-crash</code> : 创建 ceph-crash 的 systemd 单元文件，启动 ceph-crash服务；</li><li><code>ceph-dashboard</code> : 调整 dashboard 的配置；</li><li><code>ceph-defaults</code> : 包含 ceph 所有组件的基础的默认配置；</li><li><code>ceph-facts</code> : 获取集群设备信息，获取集群 crush 信息，设置 grafana&#x2F;radosgw 地址信息等；</li><li><code>ceph-fetch-keys</code> : 复制 ceph 和 bootstrap 的密钥到本地的指定目录；</li><li><code>ceph-grafana</code> : 变更 grafana 相关配置，启动 grafana 服务；</li><li><code>ceph-handler</code> : 包含的 handlers 的程序，主要涉及到对 ceph 相关的进程进行一些重启操作：</li><li><code>ceph-infra</code> : 修改一些防火墙，时间同步等的配置；</li><li><code>ceph-iscsi-gw</code> : 配置 iscsi-gw 相关服务；</li><li><code>ceph-mds</code> : 配置并启动 mds 服务；</li><li><code>ceph-mgr</code> : 配置并启动 mgr 服务；</li><li><code>ceph-mon</code> : 配置并启动 mon 服务；</li><li><code>ceph-nfs</code> : 配置并启动 nfs 服务；</li><li><code>ceph-node-exporter</code> : 配置并启动 node-exporter 服务；</li><li><code>ceph-osd</code> : 配置并启动 osd 服务；</li><li><code>ceph-prometheus</code> : 配置并启动 prometheus 服务；</li><li><code>ceph-rbd-mirror</code> : 配置并启动 rbd-mirror 服务；</li><li><code>ceph-rgw</code> : 配置并启动 rgw 服务；</li><li><code>ceph-rgw-loadbalancer</code> : 配置并启动 mgr-loadbalancer 服务；</li><li><code>ceph-validate</code> : 部署 ceph 之前验证各种环境的配置是否正常；</li></ul><h1 id="二、集群部署"><a href="#二、集群部署" class="headerlink" title="二、集群部署"></a>二、集群部署</h1><p><strong>建议使用如下的 python&#x2F;ansible 环境运行 ceph-ansible ：</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># stable-6.0</span><br>pyenv install 3.8.16<br>pip install ansible==2.10.7<br><br><span class="hljs-comment"># stable-7.0</span><br>pyenv install 3.10.14<br>pip install ansible==8.7.0<br><br><span class="hljs-comment"># stable-8.0</span><br>pyenv install 3.10.14<br>pip install ansible==9.8.0<br><br><span class="hljs-comment"># stable-9.0</span><br>pyenv install 3.10.14<br>pip install ansible==9.8.0<br></code></pre></td></tr></table></figure><p><strong>下载 ceph-ansible 并安装依赖：</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/ceph/ceph-ansible.git<br>git checkout <span class="hljs-variable">$branch</span><br>pip install -r requirements.txt<br>ansible-galaxy install -r requirements.yml<br></code></pre></td></tr></table></figure><p><strong>相关操作命令：</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 探测节点</span><br>ansible -i hosts.ini -m ping all<br><br><span class="hljs-comment"># 采集节点信息</span><br>ansible -i hosts.ini -m setup all<br><br><span class="hljs-comment"># 部署集群</span><br>ansible-playbook -vvvv -i hosts.ini site.yml<br><br><span class="hljs-comment"># 销毁集群</span><br>ansible-playbook -vvvv -i hosts.ini infrastructure-playbooks/purge-cluster.yml<br><br><span class="hljs-comment"># 变更 mds</span><br>ansible-playbook -vvvv -i hosts.ini site.yml --<span class="hljs-built_in">limit</span> mdss<br><br><span class="hljs-comment"># 变更 osd</span><br>ansible-playbook -vvvv -i hosts.ini site.yml --<span class="hljs-built_in">limit</span> osds<br><br><span class="hljs-comment"># 清理异常的 lvm </span><br><span class="hljs-built_in">sudo</span> dmsetup <span class="hljs-built_in">ls</span><br><span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r line; <span class="hljs-keyword">do</span><br>    oline=<span class="hljs-variable">$line</span><br>    nline=<span class="hljs-variable">$&#123;line%-osd--block-*&#125;</span><br>    <span class="hljs-built_in">sudo</span> dmsetup remove <span class="hljs-variable">$oline</span><br>    <span class="hljs-built_in">sudo</span> lvremove /dev/mapper/<span class="hljs-variable">$oline</span><br>    <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">rm</span> -rf /dev/<span class="hljs-variable">$nline</span><br><span class="hljs-keyword">done</span> &lt; &lt;(<span class="hljs-built_in">sudo</span> dmsetup <span class="hljs-built_in">ls</span> | grep <span class="hljs-string">&quot;ceph--&quot;</span> | awk -F <span class="hljs-string">&#x27; &#x27;</span> <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span>)<br><br><span class="hljs-comment"># 查看 crush map</span><br>ceph osd getcrushmap -o crushmap.file<br>crushtool -d crushmap.file -o crushmap-human.file<br><span class="hljs-built_in">cat</span> crushmap-human.file<br></code></pre></td></tr></table></figure><h1 id="三、集群运维"><a href="#三、集群运维" class="headerlink" title="三、集群运维"></a>三、集群运维</h1><p>以下运维脚本基于 stable-6.0 分支代码。</p><h2 id="3-1、移除-MDS-组件"><a href="#3-1、移除-MDS-组件" class="headerlink" title="3.1、移除 MDS 组件"></a>3.1、移除 MDS 组件</h2><p>ceph-ansible 提供了移除 mds 的相关脚本，但是对于 cephfs 相关 pool 的删除仍需手动操作。详细操作步骤如下。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 确保 hosts.ini 配置文件与集群最新的配置文件一致</span><br>vi hosts.ini<br><br><span class="hljs-comment"># 验证集群节点连通性，必要时需要将当前控制节点的公钥传输给对应节点</span><br>ansible -i hosts.ini -m ping all<br><br><span class="hljs-comment"># 移除 MDS 组件（最后移除 active 状态的 MDS）</span><br>ansible-playbook infrastructure-playbooks/shrink-mds.yml -vvvv -i hosts.ini -e mds_to_kill=ceph02<br>ansible-playbook infrastructure-playbooks/shrink-mds.yml -vvvv -i hosts.ini -e mds_to_kill=ceph01<br><br><span class="hljs-comment"># 查看集群状态</span><br>ceph fs status<br>ceph osd pool <span class="hljs-built_in">ls</span> detail<br><br><span class="hljs-comment"># 移除 CephFS 相关 Pool</span><br>ceph tell mon.\* injectargs <span class="hljs-string">&#x27;--mon-allow-pool-delete=true&#x27;</span><br>ceph osd pool delete cephfs_metadata cephfs_metadata --yes-i-really-really-mean-it<br>ceph osd pool delete cephfs_data cephfs_data --yes-i-really-really-mean-it<br>ceph tell mon.\* injectargs <span class="hljs-string">&#x27;--mon-allow-pool-delete=false&#x27;</span><br><br><span class="hljs-comment"># 修改 hosts.ini 文件，移除 mdss 配置</span><br>vi hosts.ini<br><br><span class="hljs-comment"># 查看集群状态</span><br>ceph fs status<br>ceph osd pool <span class="hljs-built_in">ls</span> detail<br></code></pre></td></tr></table></figure><h2 id="3-2、新增-MDS-组件"><a href="#3-2、新增-MDS-组件" class="headerlink" title="3.2、新增 MDS 组件"></a>3.2、新增 MDS 组件</h2><p>该步骤新增 MDS 的操作是基于新增 OSD 组件之后的进行的操作，所以步骤较为繁琐，如果是在没有新增 OSD 组件的情况下，且是在现有机器节点中新增 MDS 组件，则不需要修改对应的 host_vars 目录中文件。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 确保 hosts.ini 配置文件与集群最新的配置文件一致，并新增 mdss 配置</span><br>vi hosts.ini<br><br><span class="hljs-comment"># 修改 cephfs 的配置 ，主要是 meta pool 和 data pool 的配置， 以及其他的配置（内存大小，trim cache 的时间控制配置等）</span><br>vi group_vars/all.yml<br><br><span class="hljs-comment"># 新增 MDS 组件的节点信息</span><br><span class="hljs-built_in">ls</span> -al host_vars/<br>vi host_vars/ceph04.yml<br>vi host_vars/ceph05.yml<br>vi host_vars/ceph06.yml<br><br><span class="hljs-comment"># 更新当前控制节点的 hosts 文件</span><br>vi /etc/hosts<br><br><span class="hljs-comment"># 验证集群节点连通性，必要时需要将当前控制节点的公钥传输给对应节点</span><br>ansible -i hosts.ini -m ping all<br><br><span class="hljs-comment"># 采集机器节点信息，如果在操作时本地没有采集到新增机器节点的信息，可能会导致操作异常</span><br>ansible -i hosts.ini -m setup all<br><br><span class="hljs-comment"># 新增 MDS 组件</span><br>ansible-playbook -vvvv -i hosts.ini site.yml --<span class="hljs-built_in">limit</span> mdss<br><br><span class="hljs-comment"># 查看集群状态</span><br>ceph fs status<br>ceph osd pool <span class="hljs-built_in">ls</span> detail<br></code></pre></td></tr></table></figure><p>新增 MDS 组件的相关示例文件如下：<br><strong>hosts.ini</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[mgrs]<br>ceph01<br>ceph02<br>ceph03<br><br>[mons]<br>ceph01<br>ceph02<br>ceph03<br><br>[mdss]<br>ceph04<br>ceph05<br>ceph06<br><br>[clients]<br>ceph01<br>ceph02<br>ceph03<br>ceph04<br>ceph05<br>ceph06<br><br>[osds]<br>ceph01<br>ceph02<br>ceph03<br>ceph04<br>ceph05<br>ceph06<br><br>[grafana-server]<br>ceph01<br>ceph02<br>ceph03<br>ceph04<br>ceph05<br>ceph06<br></code></pre></td></tr></table></figure><p><strong>group_vars&#x2F;all.yml</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># cephfs</span><br>cephfs: cephfs<br>cephfs_metadata_pool:<br>  name: cephfs_metadata<br>  pg_num: 256<br>  pgp_num: 256<br>  size: 3<br>  min_size: 1<br>  rule_name: cephfs_rule<br>  pg_autoscale_mode: off<br>cephfs_data_pool:<br>  name: cephfs_data<br>  pg_num: 1024<br>  pgp_num: 1024<br>  size: 2<br>  min_size: 1<br>  rule_name: cephfs_rule<br>  pg_autoscale_mode: off<br><br><span class="hljs-comment"># other</span><br>ceph_conf_overrides:<br>  osd:<br>    osd memory target: 11779558604<br>  mds:<br>    mds cache trim interval: 10<br>    mds cache trim threshold: 262144<br>    mds cache memory <span class="hljs-built_in">limit</span>: 34359738368<br></code></pre></td></tr></table></figure><h2 id="3-3、新增-OSD-组件"><a href="#3-3、新增-OSD-组件" class="headerlink" title="3.3、新增 OSD 组件"></a>3.3、新增 OSD 组件</h2><p>需要注意新增的 OSD 是否会与现有的 OSD 位于同一个 crush rule，如果只是为了扩容现有 rbd&#x2F;cephfs 的存储空间，通常会位于同一个 crush rule；如果新增的 OSD 是为了承接新功能且需要与现有存储隔离开，那可能就需要创建并加入到新的 crush rule 中，为此我们需要修改对应 group_vars 和 host_vars 目录中的相关文件。</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 备份集群配置</span><br>ceph osd getcrushmap -o crushmap.file<br>crushtool -d crushmap.file -o crushmap-human.file<br>ceph osd crush class <span class="hljs-built_in">ls</span><br>ceph osd crush rule <span class="hljs-built_in">ls</span><br>ceph osd crush tree<br><br><span class="hljs-comment"># 确保 hosts.ini 配置文件与集群最新的配置文件一致，并新增 osds 配置</span><br>vi hosts.ini<br><br><span class="hljs-comment"># 修改文件中关于 osd 对象存储，内存限制等配置</span><br>vi group_vars/all.yml<br><br><span class="hljs-comment"># 注意是否加入现有的 crush rule 中，从而要修改对应的配置</span><br><span class="hljs-comment"># 修改文件中 devices 及 crush rule 等相关配置</span><br>vi group_vars/osds.yml<br><br><span class="hljs-comment"># 新增对应 OSD 组件所在节点的信息</span><br>vi host_vars/ceph04.yml<br>vi host_vars/ceph05.yml<br>vi host_vars/ceph06.yml<br><br><span class="hljs-comment"># 更新当前控制节点的 hosts 文件</span><br>vi /etc/hosts<br><br><span class="hljs-comment"># 验证集群节点连通性，必要时需要将当前控制节点的公钥传输给对应节点</span><br>ansible -i hosts.ini -m ping all<br><br><span class="hljs-comment"># 采集机器节点信息，如果在操作时本地没有采集到新增机器节点的信息，可能会导致操作异常</span><br>ansible -i hosts.ini -m setup all<br><br><span class="hljs-comment"># 新增 OSD 组件</span><br>ansible-playbook -vvvv -i hosts.ini site.yml --<span class="hljs-built_in">limit</span> <span class="hljs-string">&quot;ceph04,ceph05,ceph06&quot;</span><br><br><span class="hljs-comment"># 查看集群状态</span><br>ceph -s<br>ceph osd tree<br>ceph osd crush class <span class="hljs-built_in">ls</span><br>ceph osd crush rule <span class="hljs-built_in">ls</span><br>ceph osd crush tree<br></code></pre></td></tr></table></figure><p>如果是创建新的 crush rule 并新增 OSD 组件的情况下，相关的参考配置及解释如下：</p><ul><li>新增的 crush rule 名称为 cephfs_rule ： 使当前集群新增 cephfs 的功能，并且 cephfs 相关的数据存储在独立的 osd 组件中；</li><li>新增 3 台机器，每台机器上部署 6 块硬盘用于存储 osd 数据；</li></ul><p><strong>hosts.ini</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[mgrs]<br>ceph01<br>ceph02<br>ceph03<br><br>[mons]<br>ceph01<br>ceph02<br>ceph03<br><br>[clients]<br>ceph01<br>ceph02<br>ceph03<br>ceph04<br>ceph05<br>ceph06<br><br>[osds]<br>ceph01<br>ceph02<br>ceph03<br>ceph04<br>ceph05<br>ceph06<br><br>[grafana-server]<br>ceph01<br>ceph02<br>ceph03<br>ceph04<br>ceph05<br>ceph06<br></code></pre></td></tr></table></figure><p><strong>group_vars&#x2F;all.yml</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># osd</span><br>osd_objectstore: bluestore<br>osd_memory_target: 11779558604<br><br><span class="hljs-comment"># other</span><br>ceph_conf_overrides:<br>  osd:<br>    osd memory target: 11779558604<br></code></pre></td></tr></table></figure><p><strong>group_vars&#x2F;osds.yml</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">---<br>dummy:<br>devices:<br>  - /dev/nvme0n1<br>  - /dev/nvme1n1<br>  - /dev/nvme2n1<br>  - /dev/nvme3n1<br>  - /dev/nvme4n1<br>  - /dev/nvme5n1<br><br>create_crush_tree: <span class="hljs-literal">true</span><br>crush_rule_config: <span class="hljs-literal">true</span><br><br>crush_rule_cephfs:<br>  name: cephfs_rule<br>  root: cephfs<br>  <span class="hljs-built_in">type</span>: host<br>  default: <span class="hljs-literal">false</span><br><br>crush_rules:<br>  - <span class="hljs-string">&quot;&#123;&#123; crush_rule_cephfs &#125;&#125;&quot;</span><br></code></pre></td></tr></table></figure><p><strong>host_vars&#x2F;ceph04.yml</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">monitor_interface: bond0<br>radosgw_interface: bond0<br><br>devices:<br>  - /dev/nvme0n1<br>  - /dev/nvme1n1<br>  - /dev/nvme2n1<br>  - /dev/nvme3n1<br>  - /dev/nvme4n1<br>  - /dev/nvme5n1<br><br>osd_crush_location:<br>  root: cephfs<br>  host: ceph04<br></code></pre></td></tr></table></figure><h1 id="四、相关资料"><a href="#四、相关资料" class="headerlink" title="四、相关资料"></a>四、相关资料</h1><ul><li><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph-ansible">https://github.com/ceph/ceph-ansible</a></li><li><a target="_blank" rel="noopener" href="https://docs.ceph.com/projects/ceph-ansible/en/latest/">https://docs.ceph.com/projects/ceph-ansible/en/latest/</a></li><li><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/devel/reference_appendices/release_and_maintenance.html">https://docs.ansible.com/ansible/devel/reference_appendices/release_and_maintenance.html</a></li><li><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/index.html">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/index.html</a></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/biglittleant/p/12857484.html">https://www.cnblogs.com/biglittleant/p/12857484.html</a></li><li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904127785336839">https://juejin.cn/post/6844904127785336839</a></li><li><a target="_blank" rel="noopener" href="https://wangchujiang.com/reference/docs/ansible.html">https://wangchujiang.com/reference/docs/ansible.html</a></li></ul></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://bugwz.com">bugwz</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://bugwz.com/2023/04/12/ceph-ansible/">https://bugwz.com/2023/04/12/ceph-ansible/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://bugwz.com" target="_blank">咕咕</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Ceph/">Ceph</a></div><div class="post-share"><div class="social-share" data-image="/assets/images/bg/ceph.webp" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2023/05/01/ceph-cmd/" title="Ceph 常用命令汇总"><img class="cover" src="/assets/images/bg/ceph.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post" loading='lazy'><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Ceph 常用命令汇总</div></div><div class="info-2"><div class="info-item-1">一、常用命令1.1、Pool# 查看 poolceph osd pool ls detail# 创建 poolceph osd pool create testpool 32 32ceph osd pool set testpool pg_autoscale_mode off# 调整 pool pg/pgp , 并关闭自动调整ceph osd pool set testpool pg_num 32ceph osd pool set testpool pgp_num 32ceph osd pool set testpool pg_autoscale_mode off# 设置 pool 最小副本ceph osd pool set testpool min_size 1ceph osd pool set testpool size 1 --yes-i-really-mean-it# 移除 poolceph tell mon.\* injectargs &#x27;--mon-allow-pool-delete=true&#x27;ceph osd pool delete testpoo...</div></div></div></a><a class="pagination-related" href="/2023/01/10/gfs/" title="译 - The Google File System"><img class="cover" src="/assets/images/bg/paper.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post" loading='lazy'><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">译 - The Google File System</div></div><div class="info-2"><div class="info-item-1">《The Google File System》 是由 Google 公司开发的分布式文件系统，旨在解决存储海量数据的问题。GFS 采用了一些独特的设计，如基于大块的文件存储、多副本存储和自动故障恢复等。GFS 能够支持高并发、高吞吐量的数据访问，并且具有良好的扩展性和可靠性。GFS 的设计思想已经被广泛应用于其他分布式存储系统的开发中，是分布式存储领域的重要里程碑之一。 摘要We have designed and implemented the Google File System, a scalable distributed file system for large distributed data-intensive applications. It provides fault tolerance while running on inexpensive commodity hardware, and it delivers high aggregate performance to a large number of clients. 我们设计并实现了 ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2024/12/01/cephfs-samba/" title="CephFS 对接 Samba 使用教程"><img class="cover" src="/assets/images/bg/ceph.webp" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-01</div><div class="info-item-2">CephFS 对接 Samba 使用教程</div></div><div class="info-2"><div class="info-item-1">一、Samba 介绍Samba 是一款基于 GNU 通用公共许可证的自由软件，Samba 项目是软件自由保护协会 (Software Freedom Conservancy) 的成员。自 1992 年以来，Samba 一直为所有使用 SMB&#x2F;CIFS 协议的客户端（例如所有版本的 DOS 和 Windows、OS&#x2F;2、Linux 以及许多其他系统）提供安全、稳定且快速的文件和打印服务。 Samba 项目源码位于 https://git.samba.org/samba.git , 镜像代码仓库地址为 https://github.com/samba-team/samba 。 1.1、二进制包安装部署我们的机器环境为 CentOS 8.5.2111 ， 受限于系统版本较老，导致最终安装版本为 Samba 4.19.4 。以下操作基于这些环境进行。 由于安装的 Samba 软件默认缺少 vfs_ceph 的相关库，所以在测试的时候无法测试一些使用场景，因此在实际部署测试的时候并不会使用该版本进行测试，而是会采用编译安装的版本进行测试。 1.1.1、环境初始化相关命令...</div></div></div></a><a class="pagination-related" href="/2024/03/05/ceph-csi/" title="Ceph CSI 对接 K8S 指南"><img class="cover" src="/assets/images/bg/ceph.webp" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-05</div><div class="info-item-2">Ceph CSI 对接 K8S 指南</div></div><div class="info-2"><div class="info-item-1">一、介绍1.1、Ceph CSI 介绍Ceph CSI 插件实现了支持 CSI 的容器编排器 (CO) 与 Ceph 集群之间的接口。它们支持动态配置 Ceph 卷并将其附加到工作负载。项目地址: https://github.com/ceph/ceph-csi 。该仓库包含用于 RBD、CephFS 和 Kubernetes sidecar 部署 YAML 的 Ceph 容器存储接口 (CSI) 驱动程序，以支持 CSI 功能：provisioner、attacher、resizer、driver-registrar 和 snapper。 本文基于 Ceph CSI v3.14.1 版本进行测试。 Ceph CSI 驱动与测试过的 Kubernetes 版本信息表: (参考 known-to-work-co-platforms) Ceph CSI 版本 Kubernetes 版本 v3.14.1 v1.30、v1.31、v1.32 v3.14.0 v1.30、v1.31、v1.32 v3.13.1 v1.29、v1.30、v1.31 v3.13.0 v1...</div></div></div></a><a class="pagination-related" href="/2025/01/12/ceph-crimson-deploy/" title="Ceph Crimson 集群部署教程"><img class="cover" src="/assets/images/bg/ceph.webp" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-12</div><div class="info-item-2">Ceph Crimson 集群部署教程</div></div><div class="info-2"><div class="info-item-1">当前 ceph 集群搭建部署的方式主要有三种: ceph-ansible, vstart.sh 和 cephadm 。 其中 vstart.sh 脚本用于在开发环境中快速搭建测试集群。 ceph-ansible 是之前推荐的部署 ceph 集群的方式，支持在直接在宿主机上部署或者通过容器部署的方式，目前社区已不推荐使用。 cephadm 是当前最新的支持部署生产集群的方式，仅支持容器部署。接下来主要介绍通过 vstart.sh 和 cephadm 部署 crimson 集群的方式。 一、vstart.sh 搭建集群通过这种方式部署的时候理论上对于 Ceph 版本没有特殊的要求，本文中使用的版本为 v19.2.1 。 vstart.sh 常用于在开发环境环境中快速搭建集群，且在部署集群前我们需要编译出对应的二进制包。由于编译环境可能会有各种依赖缺失，版本异常等问题，这里推荐使用 bugwz&#x2F;ceph-images 中提供的 CentOS Stream 9 的编译打包环境。同时后续的集群的搭建也可以在容器内部进行。 搭建集群操作步骤如下: 软件编译: 使用开发容器镜像，编...</div></div></div></a><a class="pagination-related" href="/2025/08/09/cephfs-inode-num/" title="CephFS Inode 编号的申请与释放"><img class="cover" src="/assets/images/bg/ceph.webp" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-09</div><div class="info-item-2">CephFS Inode 编号的申请与释放</div></div><div class="info-2"><div class="info-item-1">一、Inode 编号介绍1.1、编号规则在 CephFS 中 MDS 负责管理所有的 Inode 信息。CephFS 本身支持 多MDS 策略，为了避免多MDS 分配的 Inode 出现冲突，所以 MDS 在分配 Inode 的时候需要使用 RankID 来区分 Inode 的范围。每个 MDS 中限制 Inode 分配范围的函数为 InoTable::reset_state ，每个 MDS 中负责的 Inode 范围为：[(rank+1) &lt;&lt; 40, ((rank+1) &lt;&lt; 40)) ，即从 (rank+1) &lt;&lt; 40 开始的连续 1 &lt;&lt; 40 个 Inode 。 MDSRank 起始Inode编号(十进制) 起始Inode编号(十六进制) 结束Inode编号(十六进制) 管辖的Inode数量 0 1,099,511,627,776 0x10000000000 0x1FFFFFFFFF 1,099,511,627,776 1 2,199,023,255,552 0x20000000000 0x2FFFFFF...</div></div></div></a><a class="pagination-related" href="/2023/06/10/rush/" title="译 - Replication Under Scalable Hashing: A Family of Algorithms for Scalable Decentralized Data Distribution"><img class="cover" src="/assets/images/bg/paper.jpg" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-10</div><div class="info-item-2">译 - Replication Under Scalable Hashing: A Family of Algorithms for Scalable Decentralized Data Distribution</div></div><div class="info-2"><div class="info-item-1">译作: 可扩展哈希下的复制: 可扩展分散数据分布的算法家族 , 原文地址 ，该论文发表于 2004 年 4 月在新墨西哥州圣达菲举行的第 18 届国际并行和分布式处理研讨会 (IPDPS 2004) 论文集。这篇论文介绍了一系列名为 RUSH(Replication Under Scalable Hashing) 的算法，用于在去中心化的存储系统中分配和管理数据。每种 RUSH 变体都有其独特的优势和局限性，选择哪一种取决于具体的系统需求和操作环境。 算法特点: 允许在线调整特定对象的复制程度，且不受其他对象复制程度的影响。 保证数据复制的安全性，即确保同一对象的副本不会存储在同一硬盘上。 支持加权，允许将不同年份的磁盘添加到系统中。加权可以让系统充分利用最新的技术，也可以淘汰较旧的技术。 支持最佳或接近最佳的重组，当系统添加&#x2F;淘汰磁盘时，会最大限度地减少需要移动的对象数量，以使系统恢复平衡。 支持在线重组，无需长时间锁定文件系统。 完全去中心化，无需中央目录，客户端可以并行计算数据位置。 极少的资源需求，算法速度非常快，并且占用的内存极少。 算法类别: R...</div></div></div></a><a class="pagination-related" href="/2023/05/01/ceph-cmd/" title="Ceph 常用命令汇总"><img class="cover" src="/assets/images/bg/ceph.webp" alt="cover" loading='lazy'><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-01</div><div class="info-item-2">Ceph 常用命令汇总</div></div><div class="info-2"><div class="info-item-1">一、常用命令1.1、Pool# 查看 poolceph osd pool ls detail# 创建 poolceph osd pool create testpool 32 32ceph osd pool set testpool pg_autoscale_mode off# 调整 pool pg/pgp , 并关闭自动调整ceph osd pool set testpool pg_num 32ceph osd pool set testpool pgp_num 32ceph osd pool set testpool pg_autoscale_mode off# 设置 pool 最小副本ceph osd pool set testpool min_size 1ceph osd pool set testpool size 1 --yes-i-really-mean-it# 移除 poolceph tell mon.\* injectargs &#x27;--mon-allow-pool-delete=true&#x27;ceph osd pool delete testpoo...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/assets/images/bg/avatar.webp" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"/ loading='lazy'></div><div class="author-info-name">bugwz</div><div class="author-info-description">持续学习，持续进步</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">137</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">139</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/bugwz" target="_blank" title="Github"><i class="fab fa-github" style="color:#24292e"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="toc-text">一、项目介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1%E3%80%81%E7%89%88%E6%9C%AC%E4%B8%8E%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="toc-text">1.1、版本与对应关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2%E3%80%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-text">1.2、目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9D%97"><span class="toc-text">1.3、自定义模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BB%BB%E5%8A%A1"><span class="toc-text">1.4、自定义任务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-text">二、集群部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%9B%86%E7%BE%A4%E8%BF%90%E7%BB%B4"><span class="toc-text">三、集群运维</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1%E3%80%81%E7%A7%BB%E9%99%A4-MDS-%E7%BB%84%E4%BB%B6"><span class="toc-text">3.1、移除 MDS 组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2%E3%80%81%E6%96%B0%E5%A2%9E-MDS-%E7%BB%84%E4%BB%B6"><span class="toc-text">3.2、新增 MDS 组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3%E3%80%81%E6%96%B0%E5%A2%9E-OSD-%E7%BB%84%E4%BB%B6"><span class="toc-text">3.3、新增 OSD 组件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99"><span class="toc-text">四、相关资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/25/proxyassistant/" title="ProxyAssistant - 强大的浏览器代理管理扩展"><img src="/assets/images/bg/proxyassistant.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ProxyAssistant - 强大的浏览器代理管理扩展"/ loading='lazy'></a><div class="content"><a class="title" href="/2026/01/25/proxyassistant/" title="ProxyAssistant - 强大的浏览器代理管理扩展">ProxyAssistant - 强大的浏览器代理管理扩展</a><time datetime="2026-01-24T16:00:00.000Z" title="发表于 2026-01-25 00:00:00">2026-01-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/06/ceph-cmd-register-exec/" title="Ceph 命令注册及执行流程"><img src="/assets/images/bg/ceph.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Ceph 命令注册及执行流程"/ loading='lazy'></a><div class="content"><a class="title" href="/2025/12/06/ceph-cmd-register-exec/" title="Ceph 命令注册及执行流程">Ceph 命令注册及执行流程</a><time datetime="2025-12-05T16:00:00.000Z" title="发表于 2025-12-06 00:00:00">2025-12-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/11/08/ceph_linux_versions/" title="Ceph 和 LinuxKernel 版本时间对照表"><img src="/assets/images/bg/ceph.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Ceph 和 LinuxKernel 版本时间对照表"/ loading='lazy'></a><div class="content"><a class="title" href="/2025/11/08/ceph_linux_versions/" title="Ceph 和 LinuxKernel 版本时间对照表">Ceph 和 LinuxKernel 版本时间对照表</a><time datetime="2025-11-07T16:00:00.000Z" title="发表于 2025-11-08 00:00:00">2025-11-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/09/cephfs-inode-num/" title="CephFS Inode 编号的申请与释放"><img src="/assets/images/bg/ceph.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="CephFS Inode 编号的申请与释放"/ loading='lazy'></a><div class="content"><a class="title" href="/2025/08/09/cephfs-inode-num/" title="CephFS Inode 编号的申请与释放">CephFS Inode 编号的申请与释放</a><time datetime="2025-08-08T16:00:00.000Z" title="发表于 2025-08-09 00:00:00">2025-08-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/01/ceph-cirmson/" title="Ceph Crimson 设计实现深入解析"><img src="/assets/images/bg/ceph.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Ceph Crimson 设计实现深入解析"/ loading='lazy'></a><div class="content"><a class="title" href="/2025/06/01/ceph-cirmson/" title="Ceph Crimson 设计实现深入解析">Ceph Crimson 设计实现深入解析</a><time datetime="2025-05-31T16:00:00.000Z" title="发表于 2025-06-01 00:00:00">2025-06-01</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/assets/images/bg/ceph.webp)"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2019 - 2026 By bugwz</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.1.1</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(()=>{const e=e=>{const t=(e=>{if(!e)return null;const t=e.trim().split(/[\s,]+/).map(e=>Number(e));return 4!==t.length||t.some(e=>Number.isNaN(e))?null:t})(e.getAttribute("viewBox"));if(t)return t;try{const t=e.getBBox();if(t&&t.width&&t.height)return[t.x,t.y,t.width,t.height]}catch(e){}const n=Number(e.getAttribute("width"))||0,r=Number(e.getAttribute("height"))||0;return n>0&&r>0?[0,0,n,r]:[0,0,100,100]},t=(e,t)=>{e.setAttribute("viewBox",`${t[0]} ${t[1]} ${t[2]} ${t[3]}`)},n=(e,t,n)=>Math.max(t,Math.min(n,e)),r=({source:e,initViewBox:t})=>{const n=(()=>{if("string"==typeof e){const t=document.createElement("template");t.innerHTML=e.trim();const n=t.content.querySelector("svg");return n?n.cloneNode(!0):null}return e&&"function"==typeof e.cloneNode?e.cloneNode(!0):null})();if(!n)return;t&&4===t.length&&n.setAttribute("viewBox",t.join(" ")),n.getAttribute("xmlns")||n.setAttribute("xmlns","http://www.w3.org/2000/svg"),!n.getAttribute("xmlns:xlink")&&n.outerHTML.includes("xlink:")&&n.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");const r="dark"===document.documentElement.getAttribute("data-theme"),i=getComputedStyle(document.body).backgroundColor||(r?"#1e1e1e":"#ffffff");n.style.background||(n.style.background=i);const o=(new XMLSerializer).serializeToString(n),s=new Blob([o],{type:"image/svg+xml;charset=utf-8"}),a=URL.createObjectURL(s);window.open(a,"_blank","noopener"),setTimeout(()=>URL.revokeObjectURL(a),3e4)},i=(e,t,n,r)=>{const i=e[2]*t,o=e[3]*t;return[n-(n-e[0])*t,r-(r-e[1])*t,i,o]},o=r=>{const o=r.querySelector("svg");if(!o)return;const s=e(o);if(r.__mermaidInitViewBox=s,r.__mermaidCurViewBox=s.slice(),t(o,s),r.__mermaidGestureBound)return;r.__mermaidGestureBound=!0;const a=(t,n)=>{const i=o.getBoundingClientRect(),s=r.__mermaidCurViewBox||e(o);return{x:s[0]+(t-i.left)*(s[2]/i.width),y:s[1]+(n-i.top)*(s[3]/i.height),rect:i,vb:s}},d={pointers:new Map,startVb:null,startDist:0,startCenter:null},m=e=>{e=(e=>{const t=r.__mermaidInitViewBox||e,i=.1*t[2],o=10*t[2],s=.1*t[3],a=10*t[3];return e[2]=n(e[2],i,o),e[3]=n(e[3],s,a),e})(e),r.__mermaidCurViewBox=e,t(o,e)},l=e=>{d.pointers.delete(e.pointerId),0===d.pointers.size?(d.startVb=null,d.startDist=0,d.startCenter=null,r.__mermaidLastSinglePointer=null):1===d.pointers.size&&(r.__mermaidLastSinglePointer=[...d.pointers.values()][0])};o.addEventListener("pointerdown",t=>{if("mouse"!==t.pointerType||0===t.button)if(o.setPointerCapture(t.pointerId),d.pointers.set(t.pointerId,{x:t.clientX,y:t.clientY}),1===d.pointers.size)d.startVb=(r.__mermaidCurViewBox||e(o)).slice();else if(2===d.pointers.size){const t=[...d.pointers.values()],n=t[0].x-t[1].x,i=t[0].y-t[1].y;d.startDist=Math.hypot(n,i),d.startVb=(r.__mermaidCurViewBox||e(o)).slice(),d.startCenter={x:(t[0].x+t[1].x)/2,y:(t[0].y+t[1].y)/2}}}),o.addEventListener("pointermove",t=>{if(d.pointers.has(t.pointerId)){if(d.pointers.set(t.pointerId,{x:t.clientX,y:t.clientY}),1===d.pointers.size&&d.startVb){const n=[...d.pointers.values()][0],i=(t.clientX,t.movementX,t.clientY,t.movementY,r.__mermaidLastSinglePointer||n),s=n.x-i.x,l=n.y-i.y;r.__mermaidLastSinglePointer=n;const{rect:c}=a(n.x,n.y),u=(r.__mermaidCurViewBox||e(o)).slice(),p=s*(u[2]/c.width),x=l*(u[3]/c.height);return void m([u[0]-p,u[1]-x,u[2],u[3]])}if(2===d.pointers.size&&d.startVb&&d.startDist>0){const e=[...d.pointers.values()],t=e[0].x-e[1].x,n=e[0].y-e[1].y,r=Math.hypot(t,n);if(!r)return;const o=d.startDist/r,s={x:(e[0].x+e[1].x)/2,y:(e[0].y+e[1].y)/2},l=a(s.x,s.y),c=l.x,u=l.y,p=i(d.startVb,o,c,u);m(p)}}}),o.addEventListener("pointerup",l),o.addEventListener("pointercancel",l),o.addEventListener("wheel",t=>{t.preventDefault();const n=t.deltaY>0?1.1:.9,{x:s,y:d}=a(t.clientX,t.clientY),l=(r.__mermaidCurViewBox||e(o)).slice();m(i(l,n,s,d))},{passive:!1}),o.addEventListener("dblclick",()=>{const e=r.__mermaidInitViewBox;e&&(r.__mermaidCurViewBox=e.slice(),t(o,e))})},s=e=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";e.forEach((e,n)=>{const i=e.firstElementChild,s=e.querySelector("svg");s&&s.remove(),e.__mermaidGestureBound=!1;const a=i.dataset.config?JSON.parse(i.dataset.config):{};a.theme||(a.theme=t);const d=`mermaid-${n}`,m=`%%{init: ${JSON.stringify(a)}}%%\n`+i.textContent,l=mermaid.render(d,m),c=t=>{i.insertAdjacentHTML("afterend",t),o(e),e.__mermaidOriginalSvg=t,(e=>{const t=e.__mermaidOriginalSvg;let n=e.querySelector(".mermaid-open-btn");n||(n=document.createElement("button"),n.type="button",n.className="mermaid-open-btn",e.appendChild(n)),n.innerHTML='<i class="fa fa-search fa-fw" aria-hidden="true"></i>',n.__mermaidViewerBound||(n.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const i=t||e.querySelector("svg");if(!i)return;const o=e.__mermaidInitViewBox;r({source:i,initViewBox:o})}),n.__mermaidViewerBound=!0)})(e)};"string"==typeof l?c(l):l.then(({svg:e})=>c(e))})},a=()=>{(()=>{const e=document.querySelectorAll("pre > code.mermaid");0!==e.length&&e.forEach(e=>{const t=document.createElement("pre");t.className="mermaid-src",t.hidden=!0,t.textContent=e.textContent;const n=document.createElement("div");n.className="mermaid-wrap",n.appendChild(t),e.parentNode.replaceWith(n)})})();const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>s(e);btf.addGlobalFn("themeChange",t,"mermaid"),window.loadMermaid?t():btf.getScript("/pluginsSrc/mermaid/dist/mermaid.min.js").then(t)};btf.addGlobalFn("encrypt",a,"mermaid"),window.pjax?a():document.addEventListener("DOMContentLoaded",a)})()</script><script>(()=>{const t="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,e=null,n=t=>{const e=document.querySelector("#post-meta .gitalk-comment-count");e&&(e.textContent=t)},i=(i,o)=>{t&&(window.shuoshuoComment.destroyGitalk=()=>{i.children.length&&(i.innerHTML="",i.classList.add("no-comment"))});new Gitalk({clientID:"6af3be16b94cec39bcf6",clientSecret:"ff79d2c5b817fe837ad43a1d9f8e0dd68190ceb5",repo:"bugwz.github.io",owner:"bugwz",admin:["bugwz"],updateCountCallback:n,...e,id:t?o:"9fc256fd17d22d01ae69f6c86efccddf"}).render("gitalk-container")},o=async(t,e)=>{"function"==typeof Gitalk||(await btf.getCSS("/pluginsSrc/gitalk/dist/gitalk.css"),await btf.getScript("/pluginsSrc/gitalk/dist/gitalk.min.js")),i(t,e)};t?window.shuoshuoComment={loadComment:o}:o()})()</script></div><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="/pluginsSrc/@docsearch/css/dist/style.css"/><script src="/pluginsSrc/@docsearch/js/dist/umd/index.js"></script><script>(()=>{docsearch(Object.assign({appId:"PFB3WGSSCO",apiKey:"3e9cd446e41d93f2f130b91698b699f7",indexName:"bugwz",container:"#docsearch",placeholder:"请输入要搜索的内容"},{maxResultsPerGroup:10}));const e=()=>{document.querySelector(".DocSearch-Button").click()},c=()=>{btf.addEventListenerPjax(document.querySelector("#search-button > .search"),"click",e)};c(),window.addEventListener("pjax:complete",c)})()</script></div></div></body></html>